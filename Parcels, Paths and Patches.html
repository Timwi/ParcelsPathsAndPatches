<!DOCTYPE html>
<html>
<head>
	<link rel='stylesheet' type='text/css' href='Parcels,%20Paths%20and%20Patches.css'>
	<script>
		let w = 9, h = 9, coroutines = {}, counter = 0, inputBlocked = false, stepsWithThumbnails = [1, 3];

		let Easing = {
			InQuad:	t => t * t,
			OutQuad:	t => -t * (t - 2),
			InOutQuad:	t => 2 * (t < .5 ? t * t : (2 - t) * t - 1),
			InCubic:	t => t * t * t,
			OutCubic:	t => ((t - 3) * t + 3) * t,
			InOutCubic:	t => t < .5 ? 4 * t * t * t : ((4 * t - 12) * t + 12) * t - 3,
			InQuart:	t => t * t * t * t,
			OutQuart:	t => (((4 - t) * t - 6) * t + 4) * t,
			InOutQuart:	t => t < .5 ? 8 * t * t * t * t : (((32 - 8 * t) * t - 48) * t + 32) * t - 7,
			InQuint:	t => t * t * t * t * t,
			OutQuint:	t => ((((t - 5) * t + 10) * t - 10) * t + 5) * t,
			InOutQuint:	t => t < .5 ? 16 * t * t * t * t * t : ((((16 * t - 80) * t + 160) * t - 160) * t + 80) * t - 15,
			InSine:	t => -Math.cos(t * Math.PI / 2) + 1,
			OutSine:	t => Math.sin(t * Math.PI / 2),
			InOutSine:	t => .5 - Math.cos(Math.PI * t) / 2,
			InExpo:	t => Math.pow(2, 10 * (t - 1)),
			OutExpo:	t => 1 - Math.pow(2, -10 * t),
			InOutExpo:	t => t < .5 ? Math.pow(2, 10 * (2*t - 1))/2 : 1 - Math.pow(2, -10 * (2*t - 1))/2,
			InCirc:	t => 1 - Math.sqrt(1 - t * t),
			OutCirc:	t => Math.sqrt((2 - t)*t),
			InOutCirc:	t => t < .5 ? (1 - Math.sqrt(1 - 4*t*t))/2 : (Math.sqrt((8 - 4*t) * t - 3) + 1)/2
		};

		async function coroutine(id, data, fnc)
		{
			let val = id === null ? null : (coroutines[id] = counter++);
			counter %= 2147483647;
			for (let ix = 0; ix < data.length; ix++)
			{
				if (typeof data[ix] === 'function')
				{
					await data[ix]();
					continue;
				}
				let startTime = await new Promise(requestAnimationFrame), elapsed = 0, dur = data[ix].d * 1000, ea = data[ix].e ?? (t => t);
				if (id !== null && coroutines[id] !== val)
					return;
				while (elapsed < dur)
				{
					let obj = data[ix].v ? Object.fromEntries(Object.entries(data[ix].v).map(([k, [s, e]]) => [k, (e-s)*ea(elapsed/dur) + s])) : null;
					if (fnc)
						fnc(obj, ix, false);
					if (data[ix].fn)
						data[ix].fn(obj, ix, false);
					elapsed = (await new Promise(requestAnimationFrame)) - startTime;
					if (id !== null && coroutines[id] !== val)
						return;
				}
				if (fnc)
					fnc(data[ix].v ? Object.fromEntries(Object.entries(data[ix].v).map(([k, v]) => [k, v[1]])) : null, ix, true);
			}
		}

		let fetchCache = {};
		async function doFetch(url, fn)
		{
			if (url in fetchCache)
				return fn ? fn(fetchCache[url]) : fetchCache[url];
			let response = await fetch(url);
			return	response.status === 403 ? false :
				response.status === 200 ? (r => fn ? fn(r) : r)(fetchCache[url] = await response.text()) :
				alert('Data could not be loaded. Contact your santa!') ?? null;
		}

		function joinSegments(segs, fn)
		{
			let svg = [];
			while (segs.length > 0)
			{
				let seg = segs.pop();
				while (true)
				{
					let extIx = segs.findIndex(sg =>
						((sg.d1 ^ 2) === seg.d1 && sg.c[0] === seg.c[0]) ||
						((sg.d1 ^ 2) === seg.d2 && sg.c[0] === seg.c[seg.c.length - 1]) ||
						((sg.d2 ^ 2) === seg.d1 && sg.c[sg.c.length - 1] === seg.c[0]) ||
						((sg.d2 ^ 2) === seg.d2 && sg.c[sg.c.length - 1] === seg.c[seg.c.length - 1]));
					if (extIx === -1)
					{
						extIx = segs.findIndex(sg =>
							((sg.c[0] === seg.c[0] || sg.c[0] === seg.c[seg.c.length - 1]) &&
								!segs.some(s => (s.c[0] === sg.c[0] && (s.d1 ^ 2) === sg.d1) || (s.c[s.c.length - 1] === sg.c[0] && (s.d2 ^ 2) === sg.d1))) ||
							((sg.c[sg.c.length - 1] === seg.c[0] || sg.c[sg.c.length - 1] === seg.c[seg.c.length - 1]) &&
								!segs.some(s => (s.c[0] === sg.c[sg.c.length - 1] && (s.d1 ^ 2) === sg.d2) ||
								(s.c[s.c.length - 1] === sg.c[sg.c.length - 1] && (s.d2 ^ 2) === sg.d2)))
						);
					}
					if (extIx === -1)
						break;
					let ext = segs[extIx];
					segs.splice(extIx, 1);
					if (seg.c[0] === ext.c[0])
					{
						seg.c.reverse();
						seg.c.pop();
						if (seg.d1 === (ext.d1 ^ 2))
							ext.c.shift();
						seg.c.push(...ext.c);
						seg.d1 = seg.d2;
						seg.d2 = ext.d2;
					}
					else if (seg.c[0] === ext.c[ext.c.length - 1])
					{
						ext.c.pop();
						if (seg.d1 === (ext.d2 ^ 2))
							seg.c.shift();
						ext.c.push(...seg.c);
						ext.d2 = seg.d2;
						seg = ext;
					}
					else if (seg.c[seg.c.length - 1] === ext.c[0])
					{
						seg.c.pop();
						if (ext.d1 === (seg.d2 ^ 2))
							ext.c.shift();
						seg.c.push(...ext.c);
						seg.d2 = ext.d2;
					}
					else if (seg.c[seg.c.length - 1] === ext.c[ext.c.length - 1])
					{
						ext.c.reverse();
						seg.c.pop();
						if (seg.d2 === (ext.d2 ^ 2))
							ext.c.shift();
						seg.c.push(...ext.c);
						seg.d2 = ext.d1;
					}
				}
				let isClosed = seg.c[0] === seg.c[seg.c.length - 1];
				svg.push(`M${seg.c.slice(isClosed ? 1 : 0).map(fn).join(' ')}${isClosed ? 'z' : ''}`);
			}
			return svg.join('');
		}

		function make(id, elemName, attrs, content, parent)
		{
			let force = elemName.startsWith('*');
			if (force) elemName = elemName.substring(1);
			let elem = document.getElementById(id) ?? (function()
			{
				let e = document.createElementNS('http://www.w3.org/2000/svg', elemName);
				e.id = id;
				if (!force)
					for (let key in attrs)
						if (attrs.hasOwnProperty(key) && !key.startsWith('*'))
						{
							if (typeof attrs[key] === 'function' && key.startsWith('on'))
								e[key] = attrs[key];
							else if (typeof attrs[key] === 'function')
								e.setAttribute(key, attrs[key]());
							else
								e.setAttribute(key, attrs[key]);
						}
				return e;
			})();
			for (let key in attrs)
				if (attrs.hasOwnProperty(key) && (key.startsWith('*') || force))
				{
					if (typeof attrs[key] === 'function' && /^\*?on/.test(key))
						elem[key.replace(/^\*/, '')] = attrs[key];
					else if (typeof attrs[key] === 'function')
						elem.setAttribute(key.replace(/^\*/, ''), attrs[key]());
					else
						elem.setAttribute(key.replace(/^\*/, ''), attrs[key]);
				}
			(parent ?? vis).appendChild(elem);
			if (content !== undefined)
			{
				if (Array.isArray(content))
					elem.textContent = content[0];
				else
					elem.innerHTML = content;
			}
			return elem;
		}

		document.addEventListener('DOMContentLoaded', async function()
		{
			if (!localStorage || !localStorage.getItem || !localStorage.setItem)
				return alert('This page requires access to local storage.');

			let lights = [[0, 1, 2, 3], [5, 6, 7, 8], [9, 10, 11, 12], [14, 15, 16, 17], [18, 19, 20, 21], [23, 24, 25, 26], [27, 28, 29, 30, 31, 32, 33, 34, 35], [39, 40, 41], [45, 46, 47, 48, 49, 50, 51, 52, 53], [54, 55, 56, 57], [59, 60, 61, 62], [63, 64, 65, 66], [68, 69, 70, 71], [72, 73, 74, 75], [77, 78, 79, 80], [0, 9, 18, 27], [1, 10, 19, 28], [2, 11, 20, 29], [3, 12, 21, 30, 39, 48, 57, 66, 75], [5, 14, 23, 32, 41, 50, 59, 68, 77], [6, 15, 24, 33], [7, 16, 25, 34], [8, 17, 26, 35], [31, 40, 49], [45, 54, 63, 72], [46, 55, 64, 73], [47, 56, 65, 74], [51, 60, 69, 78], [52, 61, 70, 79], [53, 62, 71, 80]];
			function findLightIx(sv) { return lights.findIndex(lg => (lg[0] % w === lg[1] % w) === sv.v && lg.includes(sv.i)); }
			function findLight(sv) { return lights[findLightIx(sv)]; }

			let main = document.getElementById('main'), input = document.getElementById('input'), vis = document.getElementById('vis'), div = document.getElementById('div');
			let state, stateRaw = localStorage.getItem('ppp-state');
			try { state = JSON.parse(stateRaw); } catch { }
			if (Object.prototype.toString.call(state) !== "[object Object]")
				state = {};
			if (!('steps' in state)) state.steps = [];

			let last = JSON.stringify(state.steps[state.step]);

			async function updateView(changes)
			{
				let updated = new Set(), sc = state.steps[state.step], s = sc.v;
				function mk(id, elemName, attrs, content, parent)
				{
					updated.add(id);
					return make(id, elemName, attrs, content, parent);
				}

				function sqxx(x) { return 400 + 100*x; }
				function sqx(i) { return sqxx(i%w); }
				function sqyy(y) { return 150 + 100*y; }
				function sqy(i) { return sqyy((i/w)|0); }

				// Grid
				for (let i = 0; i < w*h; i++)
				{
					let gf = 'hsl(220, 10%, 20%)';
					switch (sc.type)
					{
						case 0:
							if (i === s.i)
								gf = 'hsl(220, 15%, 60%)';
							else if (!lights.some(lg => lg.includes(i)))
								gf = 'black';
							break;
					}
					mk(`sq-${i}`, 'path', { '*fill': gf, d: `M${sqx(i)+2} ${sqy(i)+2}h96v96h-96z` });
				}

				function setupGridInput(fnc, numExtra)
				{
					for (let y = -1; y <= 10; y++)
						for (let x = -1; x <= 10; x++)
							if (fnc(x, y))
								mk(`inp-${x}-${y}`, 'path', { d: `M${sqxx(x)} ${sqyy(y)}h100v100h-100z`, 'data-x': x, 'data-y': y }, null, input);
					for (let i = 0; i < numExtra; i++)
						mk(`inp-ex-${i}`, 'path', { d: `M100 ${100+200*i}h100v100h-100z`, 'data-e': ~i }, null, input);
				}

				function generatePatches(b)
				{
					let sgm = [], W = w+1;
					for (let x = 0; x < w; x++)
						for (let y = 0; y < h; y++)
						{
							if (x < w-1 && b[x + w*y] !== b[x + 1 + w*y])
								sgm.push({ c: [x + 1 + W*y, x + 1 + W*(y+1)], d1: 0, d2: 2 });
							if (y < h-1 && b[x + w*y] !== b[x + w*(y+1)])
								sgm.push({ c: [x + W*(y+1), x + 1 + W*(y+1)], d1: 3, d2: 1 });
						}
					return joinSegments(sgm, c => `${400+100*(c%W)} ${150+100*((c/W)|0)}`);
				}

				async function render(step)
				{
					let sc = state.steps[step], s = sc.v;
					switch (sc.type)
					{
						case 0:
							let ns = [...new Set(lights.map(lg => lg[0]))];
							ns.sort((a, b) => a-b);
							for (let n = 0; n < ns.length; n++)
								mk(`cw-n-${n}`, 'text', { x: sqx(ns[n])+7, y: sqy(ns[n])+25, fill: 'hsl(220, 10%, 100%)', 'fill-opacity': '.8', 'font-size': '24' }, [n + 1]);
							for (let i = 0; i < w*h; i++)
								if (s.b[i] !== ' ' && s.b[i] !== '_')
									mk(`cw-s-${i}`, 'text', { x: sqx(i)+50, y: sqy(i)+75, fill: 'hsl(220, 10%, 100%)', 'font-size': '64', 'text-anchor': 'middle' }, [s.b[i]]);
							let l = findLight(s);
							mk('cw-hl', 'path', { fill: 'none', stroke: 'hsl(60, 80%, 45%)', 'stroke-width': 4, '*d': `M${sqx(l[0])} ${sqy(l[0])}H${sqx(l[l.length-1])+100}V${sqy(l[l.length-1])+100}H${sqx(l[0])}z` });
							Array.from(document.querySelectorAll('.cw-c')).forEach(c => {
								if (c.dataset.cell === `${s.v ? '↓' : '→'}${l[0]}`)
									c.classList.add('hl');
								else
									c.classList.remove('hl');
							});
							break;

						case 1:
							mk('frame1', 'path', { d: 'M400 150h900v900h-900z', fill: 'none', stroke: 'hsl(220, 20%, 75%)', 'stroke-width': 6 });
							mk('frame2', 'path', { fill: 'none', stroke: 'hsl(220, 20%, 75%)', 'stroke-width': 4, d: () => generatePatches(sc.b) });
							for (let i = 0; i < w*h; i++)
								if (s.b[i] === 'X')
									mk(`cl-${i}-1`, 'use', { href: '#nun-template', transform: `translate(${sqx(i)}, ${sqy(i)})` });
								else if (s.b[i] === '_')
									mk(`cl-${i}-0`, 'path', { stroke: 'hsl(0, 100%, 75%)', 'stroke-width': 10, opacity: .25, fill: 'none', d: `m${sqx(i)+20} ${sqy(i)+20} 60 60m0-60-60 60` });
							break;

						case 2:
							mk('frame1', 'path', { d: 'M400 150h900v900h-900z', fill: 'none', stroke: 'hsl(220, 20%, 75%)', 'stroke-width': 6 });
							mk('frame2', 'path', { fill: 'none', stroke: 'hsl(220, 20%, 75%)', 'stroke-width': 4, d: () => generatePatches(state.steps[state.step-2].b) });
							for (let i = 0; i < s.n.length; i++)
							{
								let cx = sc.n[i] < 0 ? 100 : sqx(sc.n[i]), cy = sc.n[i] < 0 ? 100 + 200*~sc.n[i] : sqy(sc.n[i]);
								let dx = s.n[i] < 0 ? 100 : sqx(s.n[i]), dy = s.n[i] < 0 ? 100 + 200*~s.n[i] : sqy(s.n[i]);
								if (s.n[i] !== sc.n[i])
								{
									mk(`n-${i}-f`, 'use', { href: '#nun-template', transform: `translate(${cx}, ${cy})`, opacity: .25 });
									mk(`n-${i}-a`, 'path', { '*d': `M${cx+50} ${cy+50} ${dx+50} ${dy+50}`, stroke: 'hsl(220, 20%, 80%)', 'stroke-width': '30', opacity: .2, fill: 'none', 'marker-end': 'url(#arrow-marker)' });
								}
								mk(`n-${i}-t`, 'g', { 'class': 'nun', '*transform-origin': `${dx+50} ${dy+50}` },
									`<use href='#nun-template', transform='translate(${dx}, ${dy})' />`);
							}
							break;

						case 42: // loops
							mk('frame1', 'path', { d: 'M400 150h900v900h-900z', fill: 'none', stroke: 'hsl(220, 20%, 75%)', 'stroke-width': 6 });
							if (sc.b)
								mk('frame2', 'path', { fill: 'none', stroke: 'hsl(220, 20%, 75%)', 'stroke-width': 4, d: () => generatePatches(sc.b) });
							break;

						case 47: // momentous occasion
							await render(step - 1);
							let mIx = state.steps.slice(0, step).filter(sp => sp.type === 47).length;
							mk(`mom-${mIx}-r`, '*path', { d: `M${350 + 250*mIx} 1225h250v250h-250z`, fill: 'hsl(38, 100%, 40%)', 'fill-opacity': .5, stroke: 'hsl(38, 85%, 70%)', 'stroke-width': 10, 'paint-order': 'stroke' });
							mk(`mom-${mIx}-t`, '*text', { x: 475 + 250*mIx, y: 1441, fill: 'hsl(38, 100%, 90%)', 'font-family': 'Proxima', 'font-size': 271, 'text-anchor': 'middle' }, [s.b]);
							await document.fonts.ready;
							let cursorX = s.b.length > 0 ? (bb => bb.x+bb.width+20)(document.getElementById(`mom-${mIx}-t`).getBBox()) : 475;
							if (step === state.steps.length-1)
								mk('mom-l', 'path', { '*d': `M${cursorX} 1250v200`, stroke: 'hsl(38, 100%, 90%)', 'stroke-width': 10, 'style': 'animation: .74s infinite blinking-cursor;' });
							break;
					}
				}
				await render(state.step);

				// Previous momentous occasions
				for (let sIx = 0, mIx = 0; sIx < state.steps.length-1; sIx++)
					if (state.steps[sIx].type === 47)
					{
						mk(`mom-${mIx}-r`, '*path', { d: `M${375 + 250*mIx} 1250h200v200h-200z`, fill: 'none', stroke: 'hsl(120, 20%, 80%)', 'stroke-width': 10 });
						mk(`mom-${mIx}-t`, '*text', { x: 475 + 250*mIx, y: 1419, fill: 'hsl(120, 20%, 80%)', 'font-family': 'Proxima', 'font-size': 200, 'text-anchor': 'middle' }, [state.steps[sIx].v.b]);
						mIx++;
					}

				let showCheckBtn = false;
				switch (sc.type)
				{
					case 0:
						setupGridInput((x, y) => x >= 0 && x < w && y >= 0 && y < h && s.b[x+w*y] !== '_');
						showCheckBtn = !s.b.includes(' ');
						break;

					case 1:
						setupGridInput((x, y) => x >= 0 && x < w && y >= 0 && y < h);
						showCheckBtn = s.b.replace(/[^X]/g, '').length === 9;
						break;

					case 2:
						setupGridInput((x, y) => x >= 0 && x < w && y >= 0 && y < h, 1);
						showCheckBtn = true;
						break;
				}

				if (showCheckBtn && state.step === state.steps.length - 1)
					mk('check-btn', 'g', { 'class': 'btn', onclick: checkBtnPress }, `
						<circle fill='url(#btn-check-1)' cx='1300' cy='1300' r='150' />
						<circle fill='url(#btn-check-2)' cx='1300' cy='1300' r='130' />
						<text class='btn-text' fill='white' x='0' y='42' filter='url(#shadow)'
							text-anchor='middle' font-size='128' font-family='Work Sans' font-weight='700'>CHECK<${''}/text>
						<text fill='black' x='0' y='70' transform='translate(1300, 1300) rotate(-10)'
							text-anchor='middle' font-size='32' font-family='Work Sans' font-weight='300'>(Enter)<${''}/text>
					`, input);

				// Steps bar
				if (state.steps.length > 1)
				{
					mk('steps-bar', 'path', { fill: 'hsl(222, 10%, 20%)', d: 'M1450 0h1222v150H1450z' });
					for (let i = 0; i < state.steps.length; i++)
					{
						mk(`step-${i}-btn`, 'g', { '*class': `step-btn${i === state.step ? ' sel' : ''}`, 'transform-origin': `${1525 + 80*i} 75` }, `
							<circle cx='${1525 + 80*i}' cy='75' r='40' style='fill: hsl(var(--hue), 50%, 40%)' />
							<circle cx='${1525 + 80*i}' cy='75' r='27' style='fill: hsl(var(--hue), 60%, 80%)' />
							<circle cx='${1525 + 80*i}' cy='75' r='15' style='fill: hsl(var(--hue), 50%, 30%)' />`, input);
						document.getElementById(`step-${i}-btn`).onclick = (st => async () => { state.step = st; setupStep(...await loadStep(st)); })(i);
					}
				}

				for (let thIx = 0; thIx < stepsWithThumbnails.length; thIx++)
					if (state.steps.length > stepsWithThumbnails[thIx])
					{
						let	th = stepsWithThumbnails[thIx], mx = 400, my = 150, tx = 1500, ty = 200 + 250*thIx, x1 = 375, y1 = 125, x2 = x1+950, y2 = y1+950,
							x3 = (x1-400)*2/9+1500, y3 = (y1-150)*2/9+200+250*thIx, x4 = (x2-400)*2/9+1500, y4 = (y2-150)*2/9+200+250*thIx;
						mk(`thumbnail-${th}`, 'g',
							{ 'class': 'thumbnail', transform: `translate(${tx}, ${ty}) scale(${2/9}) translate(${-mx}, ${-my})` },
							await doFetch(thumbnailUrl(th)));
						mk(`show-thumbnail-${th}`, 'g', { style: `opacity: 0; transition: opacity .147s, transform .347s; transform: scale(.9); transform-origin: ${(x3+x4)/2}px ${(y3+y4)/2}px;`, 'data-transform': `scale(.9)` }, `
							<use	opacity='.5'	href='#thumbnail-${th}' transform='translate(${mx}, ${my}) scale(${9/2}) translate(${-tx}, ${-ty})' />
							<path	opacity='.2'	d='M${x1} ${y1} ${x3} ${y3} ${x3} ${y4} ${x1} ${y2}z'	fill='white'	/> <!-- left -->
							<path	opacity='.2'	d='M${x2} ${y1} ${x4} ${y3} ${x4} ${y4} ${x2} ${y2}z'	fill='white'	/> <!-- right -->
							<path	opacity='.3'	d='M${x1} ${y1} ${x2} ${y1} ${x4} ${y3} ${x3} ${y3}z'	fill='white'	/> <!-- top -->
							<path	opacity='.3'	d='M${x1} ${y2} ${x3} ${y4} ${x4} ${y4} ${x2} ${y2}z'	fill='white'	/> <!-- bottom -->
						`);
					}

				for (let obj of Array.from(document.querySelectorAll('#vis>*,#input>*')))
					if (obj.id && !updated.has(obj.id) && !obj.classList.contains('nd'))
						obj.remove();

				if (changes)
				{
					localStorage.removeItem(`ppp-${state.step}-redo`);
					let undo = localStorage.getItem(`ppp-${state.step}-undo`);
					localStorage.setItem(`ppp-${state.step}-undo`, undo ? `${last}\b${undo}` : last);
					last = JSON.stringify(s);
					localStorage.setItem('ppp-state', JSON.stringify(state));
				}
			}

			function setupStep(step, json, html)
			{
				state.step = step;
				if (!state.steps[step])
					state.steps[step] = JSON.parse(json);
				let sc = state.steps[step], s = sc.v;
				last = JSON.stringify(s);

				div.innerHTML = html ?? '';
				switch (sc.type)
				{
					case 0:
						for (let e of Array.from(document.querySelectorAll('div.cw-c')))
							e.onclick = function()
							{
								if (inputBlocked)
									return false;
								let m = /^([→↓])(\d+)$/.exec(e.dataset.cell);
								s.i = m[2]|0;
								s.v = m[1] === '↓';
								updateView();
								return false;
							};
						break;
				}

				localStorage.setItem('ppp-state', JSON.stringify(state));
				updateView();
			}

			function getAnswer(step)
			{
				let inf = state.steps[step-1];
				switch (inf.type)
				{
					case 0:	return inf.v.b;
					case 1:	return inf.v.b.replace(/ /g, '_');
					case 2:	return inf.v.n.join('-');
					case 47:	return inf.v.b;
				}
			}

			async function loadStep(step)
			{
				return await doFetch(`Step${step}/data.txt${step > 0 ? `?answer=${getAnswer(step)}` : ''}`, r => [step, ...r.split(/\r?\n#\r?\n/)]);
			}

			function thumbnailUrl(step)
			{
				return `Step${step}/thumbnail.svg?answer=${getAnswer(step)}`;
			}

			async function checkBtnPress()
			{
				console.log('btn');
				if (state.step < state.steps.length-1)
					return await setupStep(...await loadStep(state.step + 1));

				if (inputBlocked)
					return false;
				let sc = state.steps[state.step], s = sc.v, ifGood, ifWrong;
				let mode = sc.type === 47
					? 1 /* momentous occasion */
					: 0 /* check button */;

				switch (mode)
				{
					case 0:  // check button
						if (document.getElementById('check-btn') === null)
							return false;

						let stops = Array.from(document.querySelectorAll('#btn-check-1>stop, #btn-check-2>stop'));
						let arr = [95, 45, 55, 75];
						for (let i = 0; i < stops.length; i++)
							stops[i].setAttribute('stop-color', `hsl(0, 0%, ${arr[i]}%)`);
						let btnText = document.querySelector('#check-btn>text.btn-text');
						ifGood = async function()
						{
							btnText.textContent = 'GOOD!';
							for (let i = 0; i < stops.length; i++)
								stops[i].setAttribute('stop-color', `hsl(100, 100%, ${arr[i]}%)`);
							await coroutine(null, [{ d: 1.47 }]);
							coroutine('check-btn', [
								{ d: 2.47 },
								{ d: 1.47, v: { h: [100, 38], s: [100, 83] }, fn: t => {
									for (let i = 0; i < stops.length; i++)
										stops[i].setAttribute('stop-color', `hsl(${t.h}, ${t.s}%, ${arr[i]}%)`);
								} }
							]);
						};
						ifWrong = async function()
						{
							btnText.textContent = 'WRONG';
							for (let i = 0; i < stops.length; i++)
								stops[i].setAttribute('stop-color', `hsl(0, 100%, ${arr[i]}%)`);
							coroutine('check-btn', [
								{ d: 2.47 },
								() => { btnText.textContent = 'CHECK'; },
								{ d: 1.47, v: { h: [0, 38], s: [100, 83] }, fn: t => {
									for (let i = 0; i < stops.length; i++)
										stops[i].setAttribute('stop-color', `hsl(${t.h}, ${t.s}%, ${arr[i]}%)`);
								} }
							]);
						};
						break;

					case 1:  // momentous occasion
						let mIx = state.steps.slice(0, state.step).filter(sp => sp.type === 47).length;
						let r = document.getElementById(`mom-${mIx}-r`), tx = document.getElementById(`mom-${mIx}-t`);
						r.setAttribute('fill',	'hsl(0, 0%, 40%)');
						r.setAttribute('stroke',	'hsl(0, 0%, 70%)');
						tx.setAttribute('fill',	'hsl(0, 0%, 90%)');
						let msg = make(null, 'text', { x: 475 + 250*mIx, y: 1245, fill: 'hsl(0, 100%, 90%)', 'font-family': 'Proxima', 'font-weight': 600, 'font-size': 92, 'text-anchor': 'middle' });
						ifGood = async function()
						{
							msg.textContent = 'GOOD!';
							msg.setAttribute('fill', 'hsl(120, 100%, 90%)');
							document.getElementById('mom-l').remove();
							r.setAttribute('fill',	'hsl(120, 100%, 40%)');
							r.setAttribute('stroke',	'hsl(120, 100%, 70%)');
							tx.setAttribute('fill',	'hsl(120, 100%, 90%)');
							await coroutine('check-mom', [
								{ d: 1.47 },
								{ d: .47, v: { s: [100, 0], o: [1, 0], rss: [100, 20], rsl: [70, 80], tl: [90, 80], s: [50, 0], fs: [271, 200], fy: [1441, 1419] }, e: Easing.OutQuad, fn: t => {
									r.setAttribute('d',	`M${(375-t.s/2) + 250*mIx} ${1250-t.s/2}h${200+t.s}v${200+t.s}h${-200-t.s}z`);
									r.setAttribute('fill-opacity',	t.o/2);
									r.setAttribute('stroke',	`hsl(120, ${t.rss}%, ${t.rsl}%)`);
									tx.setAttribute('fill',	`hsl(120, ${t.rss}%, ${t.tl}%)`);
									tx.setAttribute('font-size',	t.fs);
									tx.setAttribute('y',	t.fy);
									msg.setAttribute('opacity',	t.o);
								} }
							]);
						};
						ifWrong = async function()
						{
							msg.textContent = 'TRY AGAIN';
							r.setAttribute('fill',	'hsl(0, 100%, 40%)');
							r.setAttribute('stroke',	'hsl(0, 100%, 70%)');
							tx.setAttribute('fill',	'hsl(0, 100%, 90%)');
							coroutine('check-mom', [
								{ d: .47 },
								{ d: 1.47, v: { o: [1, 0] }, fn: t => { msg.setAttribute('opacity', t.o); } },
								{ d: 1.47, v: { h: [0, 38], s: [100, 83] }, fn: t => {
									r.setAttribute('fill',	`hsl(${t.h}, 100%, 40%)`);
									r.setAttribute('stroke',	`hsl(${t.h}, ${t.s}%, 70%)`);
									tx.setAttribute('fill',	`hsl(${t.h}, 100%, 90%)`);
								} },
								() => { msg.remove(); }
							]);
						}
						break;
				}

				let result = await loadStep(state.step + 1);
				if (result === false)
					return ifWrong();
				inputBlocked = true;
				await ifGood();
				let thIx = stepsWithThumbnails.indexOf(state.step + 1);
				if (thIx >= 0)
				{
					let svg = await doFetch(thumbnailUrl(state.step + 1));
					let tt = make('temp-thumbnail', 'g', {}, svg);
					await coroutine('swoop-thumbnail', [
						{ d: .47 },
						{ d: .87, v: { x: [400, 1500], y: [150, 200 + 250*thIx], s: [1, 2/9] }, e: Easing.OutQuart,
							fn: t => { tt.setAttribute('transform', `translate(${t.x}, ${t.y}) scale(${t.s}) translate(-400, -150)`); } }
					]);
				}
				inputBlocked = false;
				setupStep(...result);
			}

			setupStep(...await loadStep(state.step ?? 0));

			document.body.addEventListener('keydown', function(e)
			{
				let keycombo = `${e.ctrlKey ? 'Ctrl+' : ''}${e.altKey ? 'Alt+' : ''}${e.shiftKey ? 'Shift+' : ''}${e.code}`, m;

				if (	keycombo === 'Ctrl+KeyZ'	|| keycombo === 'Alt+Backspace'	||	// Undo
					keycombo === 'Ctrl+KeyY'	|| keycombo === 'Ctrl+Shift+KeyZ'	|| keycombo === 'Alt+Shift+Backspace')	// Redo
				{
					if (!inputBlocked)
					{
						let [un, re] = keycombo === 'Ctrl+KeyZ' || keycombo === 'Alt+Backspace' ? ['undo', 'redo'] : ['redo', 'undo'];
						let undo = localStorage.getItem(`ppp-${state.step}-${un}`);
						if (undo !== null)
						{
							let split = undo.split('\b'), redo = localStorage.getItem(`ppp-${state.step}-${re}`), cur = JSON.stringify(state.steps[state.step].v);
							localStorage.setItem(`ppp-${state.step}-${re}`, redo === null ? cur : `${cur}\b${redo}`);
							state.steps[state.step].v = JSON.parse(last = split[0]);
							if (split.length === 1)
								localStorage.removeItem(`ppp-${state.step}-${un}`);
							else
								localStorage.setItem(`ppp-${state.step}-${un}`, split.slice(1).join('\b'));
							localStorage.setItem('ppp-state', JSON.stringify(state));
						}
						updateView();
					}
					e.preventDefault();
					return false;
				}

				if (e.ctrlKey || e.altKey || /^F\d+$/.test(e.key))
					return true;

				if (!inputBlocked)
				{
					if (keycombo === 'Enter' || keycombo === 'NumpadEnter')
						return checkBtnPress();

					let sc = state.steps[state.step], s = sc.v, changes = false;

					switch (sc.type)
					{
						case 0:
							function nextLight()
							{
								for (let ol = findLightIx(s), oi = lights[ol].indexOf(s.i),
									l = (ol+1) % lights.length, i = 0;
									l != ol || i != oi;
									i === lights[l].length - 1 ? (i = 0, l = (l+1) % lights.length) : i++)
									if (s.b[lights[l][i]] === ' ')
									{
										s.i = lights[l][i];
										s.v = lights[l][0] % w === lights[l][1] % w;
										break;
									}
							}

							function cursorMovement(dx, dy)
							{
								for (let x = s.i % w + dx, y = ((s.i / w)|0) + dy;
									x >= 0 && x < w && y >= 0 && y < h;
									x += dx, y += dy)
									if (s.b[x + w*y] !== '_') { s.i = x + w*y; return; }
							}

							switch (keycombo)
							{
								case 'ArrowUp':	cursorMovement(0, -1);	break;
								case 'ArrowRight':	cursorMovement(1, 0);	break;
								case 'ArrowDown':	cursorMovement(0, 1);	break;
								case 'ArrowLeft':	cursorMovement(-1, 0);	break;
								case 'Space':	s.v = !s.v;	break;
								case 'Tab':	nextLight();	break;
								case 'Delete':	s.b = `${s.b.substring(0, s.i)} ${s.b.substring(s.i+1, s.b.length)}`; changes = true; break;
								case 'Shift+Tab':
									for (let ol = findLightIx(s), oi = lights[ol].indexOf(s.i),
										l = (ol+lights.length-1) % lights.length, i = lights[l].length - 1;
										l != ol || i != oi;
										i === 0 ? (l = (l+lights.length-1) % lights.length, i = lights[l].length - 1) : i--)
										if (s.b[lights[l][i]] === ' ') { s.i = lights[l][lights[l].findIndex(c => s.b[c] === ' ')]; s.v = lights[l][0] % w === lights[l][1] % w; break; }
									break;
								case 'Backspace':
									if (s.b[s.i] === ' ')
									{
										let l = findLightIx(s), i = lights[l].indexOf(s.i),
											nl = lights[i === 0 ? (l+lights.length-1) % lights.length : l];
										s.i = nl[i === 0 ? nl.length - 1 : i-1];
										s.v = nl[0] % w === nl[1] % w;
									}
									s.b = `${s.b.substring(0, s.i)} ${s.b.substring(s.i+1, s.b.length)}`;
									changes = true;
									break;

								default:
									if (m = /^Key([A-Z])$/.exec(keycombo))
									{
										s.b = `${s.b.substring(0, s.i)}${m[1]}${s.b.substring(s.i+1, s.b.length)}`;
										changes = true;
										for (let ol = findLightIx(s), oi = lights[ol].indexOf(s.i),
											i = (oi+1) % lights[ol].length, l = i === 0 ? (ol + 1) % lights.length : ol;
											l != ol || i != oi;
											i === lights[l].length - 1 ? (i = 0, l = (l+1) % lights.length) : i++)
											if (s.b[lights[l][i]] === ' ')
											{
												s.i = lights[l][i];
												s.v = lights[l][0] % w === lights[l][1] % w;
												break;
											}
									}
									break;
							}
							break;

						case 47:
							if (s.b.length > 0 && (keycombo === 'Enter' || keycombo === 'NumpadEnter'))
								return checkBtnPress();
							else if (s.b.length < 2 && (m = /^(?:Digit|Numpad)([0-9])$/.exec(keycombo)))
							{
								s.b += m[1];
								changes = true;
							}
							else if (s.b.length > 0 && keycombo === 'Backspace')
							{
								s.b = s.b.substring(0, s.b.length-1);
								changes = true;
							}
							break;
					}

					maybeUpdateView(changes);
				}
				//console.log(keycombo);
				e.preventDefault();
				return false;
			});

			function maybeUpdateView(changes)
			{
				// Sneaky: if the user is viewing an already completed step, pretend no changes were made
				if (changes && state.step < state.steps.length - 1)
				{
					state.steps[state.step].v = JSON.parse(last);
					changes = false;
				}
				updateView(changes);
			}

			let mouseX = null, mouseY = null, mouseE = null, mouseI = null, mouseStartX = null, mouseStartY = null, mouseStartE = null;

			function click(x, y, e, btns)
			{
				//console.log('click', arguments);
				let sc = state.steps[state.step], s = sc.v, changes = false, i = e ?? x + w*y;
				switch (sc.type)
				{
					case 0: s.v = s.i === (s.i = i) !== s.v; break;
					case 1: let wa = (btns & 2) ? '_' : 'X'; s.b = `${s.b.substring(0, i)}${s.b[i] === wa ? ' ' : wa}${s.b.substring(i+1, s.b.length)}`; changes = true; break;
					case 2: let ni = s.n.indexOf(i); if (ni >= 0 && btns === 2) { s.n[ni] = sc.n[ni]; changes = true; } break;
				}
				maybeUpdateView(changes);
			}
			function drag(origX, origY, origE, fromX, fromY, fromE, x, y, e, btns)
			{
				let sc = state.steps[state.step], s = sc.v, changes = false, i = e ?? x + w*y, fi = fromE ?? fromX + w*fromY, oi = origE ?? origX + w*origY;
				//console.log('drag', arguments, '█', i, fi, oi);
				if ([0].includes(sc.type))
					return click(x, y, e, btns);

				switch (sc.type)
				{
					case 1: changes = s.b[i] !== s.b[fi]; s.b = `${s.b.substring(0, i)}${s.b[fi]}${s.b.substring(i+1, s.b.length)}`; break;
					case 2: s.n[mouseI] = i; break;
				}
				maybeUpdateView(changes);
			}
			function startDrag(x, y, e, btns)
			{
				//console.log('startDrag', arguments);
				let sc = state.steps[state.step], s = sc.v, i = e ?? x + w*y;
				switch (sc.type)
				{
					case 2:
						let ni = s.n.indexOf(i);
						if (ni !== -1 && btns === 1)
						{
							document.getElementById(`n-${ni}-t`).classList.add('sel');
							mouseI = ni;
						}
						break;
				}
			}
			function endDrag(origX, origY, origE, x, y, e)
			{
				//console.log('endDrag', arguments);
				let sc = state.steps[state.step], s = sc.v, changes = false, i = e ?? x + w*y, oi = origE ?? origX + w*origY;
				switch (sc.type)
				{
					case 2:
						for (let nu of document.querySelectorAll('.nun'))
							nu.classList.remove('sel');
						changes = i !== oi;
						mouseI = null;
						break;
				}
				maybeUpdateView(changes);
			}

			document.body.addEventListener('mousedown', function(e)
			{
				if (!('x' in e.target.dataset) && !('e' in e.target.dataset))
					return true;
				mouseStartX = mouseX = e.target.dataset.x|0;
				mouseStartY = mouseY = e.target.dataset.y|0;
				mouseStartE = mouseE = 'e' in e.target.dataset ? e.target.dataset.e|0 : null;
				startDrag(mouseX, mouseY, mouseE, e.buttons);
				click(mouseX, mouseY, mouseE, e.buttons);
				e.preventDefault();
				return false;
			});
			document.body.addEventListener('mouseup', function(e)
			{
				if (!('x' in e.target.dataset) && !('e' in e.target.dataset))
					return true;
				endDrag(mouseStartX, mouseStartY, mouseStartE, mouseX, mouseY, mouseE);
				mouseX = mouseY = mouseE = mouseStartX = mouseStartY = mouseStartE = null;
			});

			document.body.addEventListener('click',	function(e) { if (!div.contains(e.target)) e.preventDefault();	});
			document.body.addEventListener('contextmenu',	function(e) { if (!div.contains(e.target)) e.preventDefault();	});

			function setThumbnailOverlay(id, on)
			{
				let el = document.getElementById(`show-${id}`);
				el.style.opacity = on ? 1 : 0;
				el.style.transform = on ? 'none' : el.dataset.transform;
				return true;
			}

			document.body.addEventListener('mouseover', function(e)
			{
				for (let tn of document.querySelectorAll('.thumbnail'))
					if (tn.contains(e.target))
						return setThumbnailOverlay(tn.id, true);
				if (mouseX === null || !('x' in e.target.dataset))
					return true;
				let x = e.target.dataset.x|0, y = e.target.dataset.y|0;
				drag(mouseStartX, mouseStartY, mouseStartE, mouseX, mouseY, mouseE, x, y, 'e' in e.target.dataset ? e.target.dataset.e|0 : null, e.buttons);
				mouseX = x;
				mouseY = y;
			});
			document.body.addEventListener('mouseout', function(e)
			{
				for (let tn of document.querySelectorAll('.thumbnail'))
					if (tn.contains(e.target))
						return setThumbnailOverlay(tn.id, false);
			});

			document.getElementById('copy').onclick = function()
			{
				let text = JSON.stringify(state, null, 4);
				if (navigator.clipboard)
					navigator.clipboard.writeText(text);
				else
				{
					let textArea = document.createElement('textarea');
					textArea.value = text;
					document.body.appendChild(textArea);
					textArea.focus();
					textArea.select();
					try {
						document.execCommand('copy');
					} catch (err) {
						console.error('Unable to copy to clipboard', err);
					}
					document.body.removeChild(textArea);
				}
			};

			document.addEventListener('paste', async function(e)
			{
				try
				{
					let j = JSON.parse((e.clipboardData || window.clipboardData).getData("text"));
					if ('steps' in j && 'step' in j)
					{
						state = { steps: j.steps, step: j.step };
						setupStep(...await loadStep(state.step));
					}
				}
				catch {}
			});
		});
	</script>
</head>
<body>
	<svg id='main' viewBox='0 0 2672 1503'>
		<defs>
			<linearGradient id='btn-check-1' gradientTransform="rotate(70)">
				<stop offset="0%" stop-color="hsl(38, 83%, 95%)" />
				<stop offset="100%" stop-color="hsl(38, 83%, 45%)" />
			</linearGradient>
			<linearGradient id='btn-check-2' gradientTransform="rotate(70)">
				<stop offset="0%" stop-color="hsl(38, 83%, 55%)" />
				<stop offset="100%" stop-color="hsl(38, 83%, 75%)" />
			</linearGradient>
			<filter id="shadow" x="-100%" y="-100%" width='200%' height='200%' filterUnits="userSpaceOnUse">
				<feDropShadow stdDeviation="10" />
			</filter>
			<marker overflow='visible' id='arrow-marker' orient='auto-start-reverse'>
				<path fill='context-stroke' stroke='context-stroke' d='M-.5 0-2 .7V-.7z' />
			</marker>
			<g id='nun-template'>
				<g transform='scale(.02) translate(1142, -200)'>
					<path fill="#8b5d38"	d="m2419 2886c0 13.8-2 128-2.9 141-.2 2.7-1.2 6 1 8.2 159 212 96.4 414-25.9 461-102 38.9-201-49.1-221-156-3.6 1.2-6.7 3.3-10.1 5-30.5 15.3-66.4 15.4-92.5-6.8-34.9-29.8-39.9-89.6-27.4-135 17.8-64.6 68.8-119 121-160 .4-10.6-.2-121-.2-132 19-2.3 38-3.9 57.1-5.8 11.2-1.1 22.3-3.3 33.6-3.1-7 1.2-14.1 1.3-21.1 2.4.3 5.6.5 111 .5 117 26.1-2.2 103-9.6 116-11.2.3-5.7.7-111 1.4-117-9.3-.4-18.5 2.2-27.8 2.1 5.1-1 1.6-.9 98-9.6z" />
					<path fill="#8b5d38"	d="m264 2884c23.5 2.4 46.9 5 70.4 7.6.2 6.2.8 112 1.4 119 26.9 3.1 104 10.4 115 11.2.1-5.7.3-111 .3-117 .4 0 68 7.3 69.9 7.6-.3 36.1-1.2 130 1.7 133 51.8 39.8 103 96.7 120 160 10.2 39 5.5 78.2-6 103-17.5 38.1-54.2 56.3-98.3 43.1-9.2-2.7-17.6-7.2-26-11.7-16.1 88.2-80.5 151-145 163-154 28.8-299-204-101-469 .6-7.1-1.5-14.3-1.6-21.5-.1-9.2-1.6-118-1.5-128z" />
					<path fill='#f4cfac'	d="m2364 3081c50.2 67.5 87.7 153 76.8 236-12.7 97.4-92.4 158-161 88.8-33.7-33.9-44.3-77.6-43.9-126 .1-9.7 1-19.3 1.1-29 .2-11.3-5-22.5-13.8-29.6-13.4-10.8-34.7-10.4-48 4.1-7.1 7.8-9.8 18.2-14.8 27.3-7.6 13.8-19.9 25.3-34.6 31.3-3.8 1.5-8.3 2.3-12.2 1-5.2-6.6-7-15.1-8.2-23.2-.4-6.3-1.6-12.6-.5-18.9.1-12.1 3.8-23.9 8.1-35.1 12.8-33.2 36.9-60.7 62.7-84.7 9.2-8.6 18.8-16.8 28.9-24.3 2.5-1.9 4.9-4.3 8-5 82.6-6.9 146-14.8 151-13.2zm-14.7-187c-.7 5.7-1 111-1.4 117-6.2.8-69.5 7.4-116 11.2-.1-5.7-.3-111-.5-117 7.6-1.2 110-11.7 117-11.3z" />
					<path fill='#8b5d38'	d="m916 4698c124 .8 248 1.1 372 1.1-1.3 11.1-1.9 122-3.2 133-20.9-.4-358 .2-366-.3-1.5-1.3-.9-3.6-1.1-5.2.2-9.7-.6-119-1.1-129z" />
					<path fill='#8b5d38'	d="m1386 4699c123-.1 246-.5 369-1.1-.1 9-.6 118-.5 127 0 2.5-.3 5-.7 7.6h-365c-1.7-11.1-1.8-122-3.2-133z" />
					<path fill='#000000'	d="m942 4833c103-.2 205 0 308-.1.2 44.2-.8 88.4.1 133 .2 10.5-4.7 20.9-12.7 27.7-5.1 4.3-11.5 6.6-17.9 7.8-19.3-2.8-445-2-460-.1-3.6-1-7.4-1.6-10.7-3.3-8.9-4.4-15.7-12.6-18.5-22.1-.6-6.1-.6-12.2-.1-18.3 2.6-9.3 9.1-17.6 17.7-22.1 64.8-33.5 129-68.2 194-102z" />
					<path fill='#000000'	d="m1422 4832 309 .1c18.3 10.5 143 74.9 194 103 14 7.6 21 25.3 16.2 40.5-4.1 13-15.9 22.9-29.3 24.7-6.7-1.4-440-3.4-460-.1-12-1.8-22.9-9.9-27.6-21.2-3.2-6.6-3.4-1.5-2.8-147z" />
					<path fill='#f4cfac'	d="m320 3081c6.9.2 130 11.8 149 13.5 4.1-.3 7.2 2.8 10.2 5.1 28.5 22.3 55.2 47.6 75.1 77.9 19 28.9 31.9 64.8 21.3 97.6-1.3 4-2.8 8.2-6 11-7.3 1.5-14.3-2.1-20.3-5.7-10.2-6.1-18.6-15-24.9-25.1-3.9-6.2-5.9-13.3-9.4-19.6-11-22.7-39.2-27.6-56.7-11.7-8.2 7.5-12.2 18.8-11.7 29.7 1.1 24.2 11.1 102-45.8 156-70.6 66.3-150-1.4-159-99.9-7.2-81.3 29.4-163 78.1-229zm14.5-188c39 4.2 78 8.5 117 12.7 0 5.7-.1 111-.3 117-9-.7-81.2-7.3-115-11.2-.6-6.3-1.2-112-1.4-119z" />
					<path fill='#000000'	d="m1475 5c730 55.5 1e3 622 1064 1348 0 12.5 10.5 123 8.7 141 .2-2.3.5-4.6.8-6.9.1 14 1.8 27.9 1.2 41.9l.9-3.9c-.2 22.3 1.8 44.6 2.4 66.9.3-3 .6-5.9.7-8.9-.1 4.6-.5 9.2-.3 13.9.7 19.4 4.4 94.6 4.3 98.1 1.9 42.7 12.7 140 18.3 182 46.8 349 134 606 138 630-56.3-6.6-150-12-295-51.3 45.7 126 73 255 76 392 .4 16.3 1.2 32.7.9 49-.5 25.3-2.6 79.4-2.5 81.2-.1 0-74.7 7.4-74.8 7.4-45.7 5-86.6 7.2-98 9.7-13.8 1.2-59.6 5.6-68.6 6.8-6.1-.1-123 12.7-151 14.6 4.6-48 6.4-69.7 4.3-120-2.8-67.8-9.9-94.7-10.2-107-.3.5-.5 1-.7 1.5-6.3-53.9-36.3-141-54.2-170-.1 102 7.4 1650 0 2138-.3 17.2-13.2 31.5-30.6 34.2-64.7 6.3-1241 1.7-1316 1.3-8.7-.6-17.9-1.1-25.8-5.5-8.3-4.7-14.7-12.6-17-21.8-3.3-13.4.5-1983 .2-2133-4.7 7.6-8 16-11.6 24.2-30.6 68.9-43.6 158-52.8 219s-.492 93-.712 141c0 0-361-38.8-380-41.7-.7-63.2-10.1-164 21.1-330 15.3-80.5 45.2-167 46.3-171-29.7 5.3-50.3 9.7-113 17.8-28.6 3.7-105 13-134 10.9 3 .1 5.9.4 8.9.8-11.5.1-23.1 1-34.6 1.2 15.1-48.5 28-80.3 63.4-216 22.9-88 56.5-243 57-255 .2.5.4 1 .7 1.5 1-12.9 35.9-182 44.6-342 1.2-5.4.7-10.9 1.3-16.3.6-5.9.2-11.9 1-17.8.9-6.9.2-13.9 1.1-20.7.8-6.8.1-13.7.8-20.4.6-5.4.4-10.8.2-16.3 1.2-28.1 6-113 5-123 .3 2.6.6 5.2 1 7.8-.6-42.1 20.3-254 20.3-254 .3.9.5 1.9.8 2.8-.2-9.4 9.9-80.6 11.3-89.8 118-790 514-1100 1024-1142 10.8.2 21.5-1.8 32.3-1.7 5.4.1 10.7-1 16-1 .1-.1 112-4.9 193 1.3z" />
					<path fill='#272727'	d="m399 2378c92.8 37.5 195 77.3 292 102-5.5 9.8-169 143-176 461-29.1-2.2-210-22.5-239-25.7-8.5-301 123-525 124-537zm1605 90.4c97.8-24.8 213-64.7 307-99.3 18.8 47.2 121 263 115 546-59.9 5.6-243 24.3-249 24.2 1-84.2-9.9-174-35-255-39.2-126-133-209-138-216z" />
					<path fill='#272727'	d="m384 740c2.3-5.1 3.6-10.6 6.3-15.5 1.6 4.6-2.3 7.6-1 74.6 2.1 111 27.4 220 69.1 323 33 81 79.8 158 86.1 166 .5 11.4 3.2 26.4 4.5 38.6 4.3 41.8 20.3 119 22.5 126 29.3 126 85.2 268 176 359-179 119-441 589-444 590-61.6 11.3-123 22.8-186 29.6-6.3.7-12.6 1.9-19 1.8 11.2-41 61.7-210 99.6-422 36.1-202 38.8-307 44.3-434 12-282 40.8-571 141-835z" />
					<path fill='#272727'	d="m2235 520c27.6 43.8 62.8 110 93.4 185 144 352 147 747 161 1e3 18.4 334 127 704 129 722-116-16.1-224-50.5-233-52.6 1-.5 2.1-.9 3.2-1.3-29-86.2-359-489-474-542 31.2-31.4 62.4-63.8 102-145 32.8-67.5 57.8-148 72.8-220 17.2-83 29.1-182 27.9-198 0-2 1.9-3.4 2.8-5.1 12.3-22.6 24.6-45.2 35.6-68.5 58.7-124 100-277 106-423 6.1-157-26.2-242-25.5-251z" />
					<path fill='#272727'	d="m1947 2507c7.5 6.2 15.3 12.2 22.1 19.2 2.5 2.1 1.5-96.2 1.4 2198 .2 2.4-2.8 1.7-4.3 2-.1 0-1232 1.3-1246-.2 0-.1.3-2182 2.1-2191 2.2-4.3 6.7-6.6 9.9-10 4.7-5 10.4-8.9 15.1-13.9 125 27.3 1074 22.2 1199-4.3z" />
					<path fill="#c0c0c0"	d="m748 1810 1166 19.7c115 53.3 215 136 297 235 85.3 103 148 221 177 307-846 300-1300 302-2067 1.5 2.4-7.2 5.1-14.3 7.7-21.4 88.6-238 243-425 419-542z" />
					<path fill='#e6e6e5'	d="m789 1847 1078 21.4c181 52.4 361 291 431 427 7.6 15.4 15.5 30.8 21.7 46.9-650 210-1144 328-1932 4 1.9-8.2 70.1-194 221-349 88-90.7 170-145 181-150z" />
					<path fill='#8b5d38'	d="m2115 1085c11.1 156-7.93 265-12.7 297s-28.6 181-88 303c-35 72-62.6 105-102 145-66.6 59.8-118 87.2-187 116-53.3 22.4-112 38.2-167 48.4-340 62.5-586-48.3-600-52.6s-22.4-8.45-31-11.6c-11.8-5.9-75.4-32.8-139-83.2-119-94.5-183-247-218-395-2.1-6.8-18-82.8-22.5-126-1.3-12.7 1.42-208 .821-221z" />
					<path fill='#272727'	d="m1313 76c278-17.2 532 60.4 736 263 13.8 13.8 39.7 43.4 55.7 64.2 9.1 13.5 2.3.6 29.5 42.4 29.7 65.4 46.7 136 53.5 208 24.2 255-78.2 462-80 475h-.9c.6-101-1555-218-1559-86.7-.4 15.5-.7 31.1-.6 46.6-1.8 3.5-2.1 7.5-2.6 11.3-1.1 8.7-2.7 17.3-3.3 26-.1 1.7-.2 3.4-.7 5-.3 1.9-1.9-.2-2-1-119-263-116-588 95.6-786 60.6-56.7 132-107 234-155 91.3-42.4 202-77.8 313-97.7 43.3-7.5 87.4-11.9 132-14.7z" />
					<path fill='#f4cfac'	d="m2051 934c3.41 267-6.53 364-8.59 376s-16.4 208-101 367c-11.7 22-24.5 43.4-40.1 62.9-106 134-314 193-482 201 .9.3 1.9.6 2.8.9-14.9-1.5-4.5 2.1-96.8 1.1-8.6-.1-17.3-.8-25.9-.2 1.2-.3 2.5-.6 3.8-.8-26.1-.2-126-7.5-224-33.5-108-28.7-223-81.6-296-165-61.8-70-104-170-129-260-25.9-92-39.5-194-45.4-289-.5-8.7-2.71-258-2.21-266l760-342z" />
					<path fill="#c0c0c0"	d="m1934 681c56 44.5 109 93.8 153 150 1.8 2.3 4.6 4.3 4.6 7.5 22.9 228 30.9 246 27.6 365l-69.5-14.5c-25.5-55.5-95.8-132-157-188-75.1-68.7-188-152-280-193-85.4-39-175-59.6-258-63.7-110-5.4-229 12.1-382 90.6-130 66.7-242 163-319 267-16.5 22.1-32.5 44.8-45.7 69.1-2.4 4.4-5 8.7-7 13.3-40.4-6.4-44.4-6.3-51.3-8.4-.2-23.6-5.4-118 2.2-210 6.2-75.4 13.2-100 19.6-146 .1-4.3 3.9-7 6.4-9.9 74.9-85.5 165-157 262-215 329-199 776-165 1094 87.3z" />
					<path fill='#8b5d38'	d="m1036 1583c10.6-2.2 21.9 1.1 30.1 8 70.4 59.2 158 101 250 101 15.3 0 30.6-.1 45.8-2.2 77.6-10.9 152-43.2 213-91.8 6.1-4.9 11.6-11.3 19.4-13.6 14.8-5.8 32.7.5 41.3 13.8 8.8 13.5 7.9 33.3-7.3 46.3-80.2 68.3-180 107-261 115-134 13.2-242-31.2-347-116-21.5-17.5-14.6-55.3 15.4-61.4z" />
					<path fill='#e6e6e5'	d="m1220 522c45.8-5.6 121-5.6 136-4.1 251 11 497 121 683 337 2.6 2.7 2.4 6.6 2.9 10.1 6.2 69.8 10.2 120 11.6 187 .3 17.6 1.1 35.3.2 52.9-84.5-118-177-200-302-281-32.4-21-65.5-41.1-100-58-114-55.4-228-80.1-352-77.1-190 4.5-389 98.6-531 216-103 85.3-164 174-168 178-.9-44.3 2.3-98.8 6.2-140 1.4-6.3 1.3-30.7 15.3-105 7.4-9.2 16-17.4 24.2-25.9 73.3-75.7 158-140 250-192 145-81.4 285-93.9 294-96.1 9.8-.8 19.7-2.7 29.7-3.3z" />
					<path fill="#5e3116"	d="m779 1074-2.7 3.9c.4-1.8.9-3.5 1.4-5.2l9-17.3c6.7-12.2 14.3-24 22.9-34.8l16.2-18.3c13.7-13.3 28.1-24.8 47.6-33.2 41-17.6 86.4-27.6 131-21.7 20 2.7 40.5 7.5 57.3 19.2 5.3 3.7 10.6 8.2 12.7 14.5 1.2 3.6-.5 7.5-3.5 9.5-16 10.8-58.5.3-76.6-3.6-58.7-12.6-115-.9-166 35.5l-15.8 13.1c-8.3 7.4-16.1 15.4-23.2 23.9z" />
					<path fill="#8b5d38"	d="m809 968c.4-3.6 2.1-7.2 5.6-8.6 6-3 13.5 3.2 12 9.7-2.3 13.4-2.9 42.6 1.2 53.5-.9 5.2 8.2 36.4 27.3 57.7 27.4-30.9 68-49.2 109-49.9 78.1-1.5 146 57.7 153 137 8 86-58.1 159-138 164-105 6.7-175-82-161-176 1.1-7.2 3.7-14.1 4.9-21.3-6.3-.4-12.5 0-18.8-.8-38.4-4.5-72.8-23.1-99.9-57.4-2.4-3.1-5.7-6.4-4.8-10.7.7-6.4 9.3-9.7 14-5.5 3.2 2.8 22.2 31.4 56.5 46.5 18.2 8 38.3 10.9 58 10.2 1.7.1 2.8-1.1 4-2.1-8.1-4.7-31.7-13.2-54.2-40l-1.3-1.3c-14.5-17.9-25.1-38.8-31.4-60.9-1.2-3.3-.4-7.1 2.3-9.5 4.2-3.8 12.3-2.3 14.1 3.3 6.3 20.5 14.2 37.1 27.1 53.9 14.5 18.8 36.1 33 52.5 38.5.6-1.3 1.7-2.5 1.8-4-1.5-3.1-20.5-21.3-30-55.2l-1.2-3.3c-2.8-15.3-7.8-24.7-3.2-67.6z" />
					<path fill='#5e3116'	d="m1821 1022c-29.7-22.7-66-37-103-39.8-54.6-4-77.4 12.3-116 12.4-7.8 0-15.9-.5-22.8-4.5-2.2-1.6-4.2-4-4.1-6.8-2.2-24.3 98.1-66.1 209-11.3 15.1 7.5 28.5 18.1 40.3 30.1l16.1 18.6c8.7 10.7 16.2 22.4 22.6 34.7l8.9 17.1c.6 1.6 1.2 3.2 1.8 4.9-1-1.1-2-2.2-3-3.2l-10.6-15.2c-7.2-8.3-14.7-16.4-22.8-23.7z" />
					<path fill="#131212"	d="m957 1048c5.9-.6 11.9-1.2 17.8-.3 59.1 2.4 111 46.9 123 105 .8 6 2.8 11.9 2.6 18 5 56.4-29.4 112-81.5 133-107 43.8-212-57.8-178-163 12.9-40.4 45.9-73.8 86.4-86.6 9.6-3 19.7-5.4 30-5.7z" />
					<path fill='#ffffff'	d="m992 1070c19.9-5.2 42.3 2.5 55 18.7 23.7 30.1 8.5 75.4-29.5 84.5-20.4 4.9-43.1-3.5-55.4-20.5-21.1-29-8-72.9 29.9-82.7z" />
					<path fill="#8b5d38"	d="m1823 964c1.6-3.4 5.5-5.8 9.3-5.1 3.9.7 7.2 4.2 7.6 8.2.8 9.3 2.1 18.7 1.9 28.1.3 8.9-1.1 17.6-1.8 26.4-.484 5.13-1.68 10.2-3.1 14.6-5.7 16-11.3 34.2-30.6 57-1.9 1.7 1 6 3.4 4.5 24.5-10.3 39.1-24 52.9-41.4 11.6-14.7 19.1-32.3 24.4-50.2.7-2.9 3.5-4.3 5.7-6 3.9 3.5 7.6 7.2 11.4 10.9-3.6 9.6-10.7 36-32.6 62.4l-1.2 1.7c-15 15.9-25.1 25.2-53.9 39.2 1.1.8 2.2 2.2 3.8 2.1 8.8.6 17.6-.1 26.4-1.1 34.5-3.9 67-26.7 85.3-52.2 2.4-3.4 6.8-6.4 11.1-4.6 3.9 1 6.4 5 5.9 8.9.1 3.1-2.3 5.4-3.9 7.7-33 41.9-76.8 60.4-120 59 32.1 106-46.8 199-147 198-48-.7-93.3-25.1-121-65.5-42.2-61.3-33.3-148 26-199 63.1-54.7 158-46.4 210 13.2 8.9-8.7 24.1-33.7 27.8-56.8l.774-4.3c4.8-29.3-1.5-49.1.7-55.3z" />
					<path fill="#131212"	d="m1671 1048c4.9-.3 9.8-1.2 14.7-.6 8 .8 16.1.6 23.9 2.9 80.6 16.3 126 104 97.3 177-19.4 49.2-66 85.5-124 86.3-5-.9-10-.5-15-.9-72.1-6-130-77.1-117-156 10.5-60.3 62.3-106 120-110z" />
					<path fill='#ffffff'	d="m1676 1089c13.1-16.8 36.4-24.6 57-18.5 17 5 30.8 18.8 36.1 35.7 8.8 28.5-9.3 60.7-38.9 67-23 6.4-52.3-6.1-62.2-33.8-6-16.8-2.9-36.3 8-50.4z" />
				</g>
			</g>
		</defs>
		<g id='ui'>
			<g id='copy' transform-origin='100 1403'>
				<circle cx='100' cy='1403' r='40' fill='hsl(220, 5%, 50%)' />
				<path transform='translate(0, 1303)' fill='hsl(220, 5%, 90%)' d='m 95,73.5 c -3.575047,0 -6.5,2.924953 -6.5,6.5 v 30 c 0,3.57505 2.924953,6.5 6.5,6.5 h 20 c 3.57505,0 6.5,-2.92495 6.5,-6.5 V 80 c 0,-3.575047 -2.92495,-6.5 -6.5,-6.5 z m 0,3 h 20 c 1.96494,0 3.5,1.535058 3.5,3.5 v 30 c 0,1.96494 -1.53506,3.5 -3.5,3.5 H 95 c -1.964942,0 -3.5,-1.53506 -3.5,-3.5 V 80 c 0,-1.964942 1.535058,-3.5 3.5,-3.5 z m -10,7 c -3.575043,0 -6.5,2.924957 -6.5,6.5 v 30 c 0,3.57504 2.924957,6.5 6.5,6.5 h 20 c 3.57504,0 6.5,-2.92496 6.5,-6.5 v -2 h -3 v 2 c 0,1.96494 -1.53506,3.5 -3.5,3.5 H 85 c -1.96494,0 -3.5,-1.53506 -3.5,-3.5 V 90 c 0,-1.96494 1.53506,-3.5 3.5,-3.5 h 2 v -3 z m 10,0 v 3 h 15 v -3 z m 0,5 v 3 h 20 v -3 z m 0,5 v 3 h 17.5 v -3 z m 0,5 v 3 h 12.5 v -3 z m 0,5 v 3 h 20 v -3 z' />
			</g>
		</g>
		<g id='vis'></g>
		<foreignObject x='1750' y='150' width='922' height='1353'>
			<div xmlns="http://www.w3.org/1999/xhtml" id='div'></div>
		</foreignObject>
		<g id='input'></g>
	</svg>
</body>
</html>